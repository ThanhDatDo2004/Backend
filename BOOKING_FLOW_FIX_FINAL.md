# üìã BOOKING FLOW - FIXES SUMMARY

## üéØ V·∫•n ƒë·ªÅ ƒê∆∞·ª£c Gi·∫£i Quy·∫øt

Backend ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ kh·∫Øc ph·ª•c 3 v·∫•n ƒë·ªÅ ch√≠nh:

### ‚úÖ V·∫•n ƒë·ªÅ 1: Th√¥ng tin ng∆∞·ªùi ƒë·∫∑t kh√¥ng ƒë∆∞·ª£c l∆∞u
**Status:** FIXED ‚úì

**Frontend g·ª≠i:**
```json
POST /fields/:fieldCode/bookings/confirm
{
  "slots": [...],
  "customer": {
    "name": "Nguy·ªÖn VƒÉn A",
    "email": "a@example.com",
    "phone": "0912345678"
  },
  "payment_method": "bank_transfer",
  "total_price": 300000
}
```

**Thay ƒë·ªïi Backend:**
- File: `backend/src/services/booking.service.ts` (line 301-328)
- Th√™m 3 c·ªôt v√†o INSERT booking: `CustomerName`, `CustomerEmail`, `CustomerPhone`
- Payload t·ª´ frontend ƒë∆∞·ª£c l∆∞u tr·ª±c ti·∫øp v√†o database

```sql
-- Tr∆∞·ªõc (KH√îNG l∆∞u customer info):
INSERT INTO Bookings (FieldCode, CustomerUserID, PlayDate, ...)

-- Sau (L∆ØU customer info):
INSERT INTO Bookings (
  FieldCode, 
  CustomerUserID, 
  CustomerName,           -- ‚úÖ NEW
  CustomerEmail,          -- ‚úÖ NEW
  CustomerPhone,          -- ‚úÖ NEW
  PlayDate, 
  ...
)
```

---

### ‚úÖ V·∫•n ƒë·ªÅ 2: Gi·ªù ƒë·∫∑t b·ªã lock s·ªõm (tr∆∞·ªõc khi thanh to√°n)
**Status:** FIXED ‚úì

**V·∫•n ƒë·ªÅ c≈©:**
- User ch·ªçn gi·ªù ‚Üí Click "X√°c nh·∫≠n ƒë·∫∑t s√¢n" ‚Üí Slot b·ªã `Status = 'booked'` ngay
- Quay l·∫°i `/booking/48` ‚Üí Gi·ªù ƒë√£ KH√îNG c√≤n available
- **Result:** Gi·ªù b·ªã lock d√π ch∆∞a thanh to√°n ‚ùå

**Gi·∫£i ph√°p m·ªõi (Hold-Lock Pattern):**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FLOW 1: Payment CH∆ØA ho√†n t·∫•t (User c√≤n trong payment page)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. User ch·ªçn gi·ªù + info ‚Üí Click "X√°c nh·∫≠n"
‚îÇ 2. POST /fields/:fieldCode/bookings/confirm
‚îÇ 3. Slot Status = 'hold'                ‚Üê 15 ph√∫t
‚îÇ    HoldExpiresAt = NOW() + 15 ph√∫t
‚îÇ 4. Backend return BookingCode + PaymentID
‚îÇ 5. Frontend display QR code SePay
‚îÇ 6. If User quay l·∫°i /booking/48:
‚îÇ    - Slot v·∫´n available ‚úì (ch∆∞a lock)
‚îÇ 7. After 15 ph√∫t:
‚îÇ    - Slot auto release ‚Üí 'available'
‚îÇ
‚îÇ Result: Gi·ªù v·∫´n c√≥ s·∫µn n·∫øu user kh√¥ng thanh to√°n ‚úì
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FLOW 2: Payment th√†nh c√¥ng (Webhook t·ª´ SePay)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. SePay webhook nh·∫≠n transfer
‚îÇ 2. Backend: updatePaymentStatus("paid")
‚îÇ 3. G·ªçi handlePaymentSuccess()
‚îÇ 4. Slot Status = 'hold' ‚Üí 'booked'     ‚úì LOCK
‚îÇ    HoldExpiresAt = NULL
‚îÇ 5. Booking Status = 'pending' ‚Üí 'confirmed'
‚îÇ    Payment Status = 'pending' ‚Üí 'paid'
‚îÇ 6. Frontend hi·ªÉn th·ªã m√£ check-in
‚îÇ
‚îÇ Result: Gi·ªù b·ªã lock vƒ©nh vi·ªÖn (ƒë√£ thanh to√°n) ‚úì
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FLOW 3: Payment th·∫•t b·∫°i (User kh√¥ng thanh to√°n)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. User kh√¥ng chuy·ªÉn kho·∫£n trong 15 ph√∫t
‚îÇ 2. Hold expires ‚Üí Slot auto release
‚îÇ   (Background job ho·∫∑c khi check availability)
‚îÇ 3. Slot Status = 'hold' ‚Üí 'available'
‚îÇ    BookingCode = NULL
‚îÇ    HoldExpiresAt = NULL
‚îÇ 4. Frontend: User quay l·∫°i /booking/48
‚îÇ    Gi·ªù v·ª´a ch·ªçn v·∫´n available ‚úì
‚îÇ
‚îÇ Result: Gi·ªù ƒë∆∞·ª£c release, ai c≈©ng c√≥ th·ªÉ ƒë·∫∑t ‚úì
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Thay ƒë·ªïi Backend:**

1. **booking.service.ts** (line 332-340):
   ```typescript
   // Tr∆∞·ªõc: Status = 'booked'
   SET Status = 'booked', BookingCode = ?, UpdateAt = NOW()
   
   // Sau: Status = 'hold' v·ªõi 15 ph√∫t expiry
   const holdExpiryTime = new Date(Date.now() + 15 * 60 * 1000);
   SET Status = 'hold', BookingCode = ?, HoldExpiresAt = ?, UpdateAt = NOW()
   ```

2. **payment.service.ts** (line 143-152):
   Th√™m logic lock slot khi payment success:
   ```typescript
   // Lock slots - change status from 'hold' to 'booked'
   UPDATE Field_Slots 
   SET Status = 'booked', HoldExpiresAt = NULL, UpdateAt = NOW()
   WHERE BookingCode = ? AND Status = 'hold'
   ```

3. **payment.service.ts** (line 244-251):
   Th√™m function release held slots:
   ```typescript
   export async function releaseHeldSlots(bookingCode: string | number) {
     UPDATE Field_Slots 
     SET Status = 'available', BookingCode = NULL, HoldExpiresAt = NULL
     WHERE BookingCode = ? AND Status = 'hold'
   }
   ```

4. **field.service.ts** (line 228-250):
   Smart slot availability check:
   ```typescript
   function mapSlotRow(slot: FieldSlotRow) {
     // Check if hold has expired
     if (slot.status === "hold" && slot.hold_expires_at) {
       if (NOW() > hold_expires_at) {
         status = "available"  // Treat as available
       }
     }
   }
   ```

---

### ‚úÖ V·∫•n ƒë·ªÅ 3: Route 404 khi xem chi ti·∫øt booking
**Status:** FRONTEND NEEDED ‚úì

**Backend ƒë√£ c√≥:**
- ‚úÖ `GET /api/bookings/:bookingCode` - Chi ti·∫øt booking
- ‚úÖ `GET /api/bookings/:bookingCode/checkin-code` - M√£ check-in

**Frontend c·∫ßn ki·ªÉm tra:**
```javascript
// Ph·∫£i c√≥ route trong frontend router:
/bookings/:bookingId          // Trang chi ti·∫øt booking
/bookings/:bookingId/checkin-code  // Trang m√£ check-in

// Khi click "Xem Chi Ti·∫øt", g·ªçi:
GET /api/bookings/42

// Khi click "Xem M√£ Check-In", g·ªçi:
GET /api/bookings/42/checkin-code
```

---

## üìä Database Schema Changes

**Field_Slots table** c·∫ßn support:
```sql
ALTER TABLE Field_Slots ADD COLUMN IF NOT EXISTS HoldExpiresAt DATETIME NULL;

-- Status values:
-- 'available' ‚Üí Ch∆∞a ƒë·∫∑t, c√≥ s·∫µn ƒë·ªÉ ƒë·∫∑t
-- 'hold'      ‚Üí ƒê∆∞·ª£c hold 15 ph√∫t, ch∆∞a lock vƒ©nh vi·ªÖn
-- 'booked'    ‚Üí ƒê√£ lock (payment th√†nh c√¥ng ho·∫∑c booking confirmed)
-- 'cancelled' ‚Üí ƒê√£ h·ªßy
```

**Bookings table** c·∫ßn support:
```sql
ALTER TABLE Bookings ADD COLUMN IF NOT EXISTS CustomerName VARCHAR(255) NULL;
ALTER TABLE Bookings ADD COLUMN IF NOT EXISTS CustomerEmail VARCHAR(255) NULL;
ALTER TABLE Bookings ADD COLUMN IF NOT EXISTS CustomerPhone VARCHAR(20) NULL;
```

---

## üîÑ API Endpoints

### 1. Create Booking (Hold slots 15 ph√∫t)
```
POST /fields/:fieldCode/bookings/confirm
Body: {
  "slots": [
    {"play_date": "2025-10-25", "start_time": "18:00", "end_time": "19:00"}
  ],
  "customer": {
    "name": "Nguy·ªÖn VƒÉn A",
    "email": "a@example.com",
    "phone": "0912345678"
  },
  "payment_method": "bank_transfer",
  "total_price": 300000
}

Response:
{
  "booking_code": "123",
  "paymentID": 456,
  "qr_code": "https://qr.sepay.vn/img?...",
  "amount": 300000,
  "slots": [...]
}
```

### 2. Check Payment Status
```
GET /api/payments/bookings/:bookingCode/status

Response:
{
  "status": "pending" | "paid" | "failed",
  "amount": 300000,
  "paidAt": "2025-10-20 18:05:00" | null
}
```

### 3. Get Booking Details
```
GET /api/bookings/:bookingCode

Response:
{
  "BookingCode": 123,
  "CustomerName": "Nguy·ªÖn VƒÉn A",
  "CustomerEmail": "a@example.com",
  "CustomerPhone": "0912345678",
  "FieldName": "S√¢n A",
  "PlayDate": "2025-10-25",
  "StartTime": "18:00",
  "EndTime": "19:00",
  "BookingStatus": "confirmed",
  "PaymentStatus": "paid",
  "slots": [...]
}
```

### 4. Get Check-In Code
```
GET /api/bookings/:bookingCode/checkin-code

Response:
{
  "bookingCode": 123,
  "checkinCode": "ABC123XYZ"
}
```

---

## üß™ Testing Checklist

- [ ] **Test 1:** User ch·ªçn gi·ªù, ƒëi·ªÅn customer info, click "X√°c nh·∫≠n"
  - [ ] Booking ƒë∆∞·ª£c t·∫°o v·ªõi status `pending`
  - [ ] Slot status = `hold` (kh√¥ng `booked`)
  - [ ] CustomerName, Email, Phone ƒë∆∞·ª£c l∆∞u
  - [ ] Return booking_code + payment_qr_code

- [ ] **Test 2:** User quay l·∫°i `/booking/48` sau 5 ph√∫t
  - [ ] Gi·ªù v·ª´a ch·ªçn v·∫´n **kh√¥ng available** (ƒëang hold) ‚úì

- [ ] **Test 3:** User quay l·∫°i `/booking/48` sau 20 ph√∫t (qu√° 15 ph√∫t)
  - [ ] Gi·ªù v·ª´a ch·ªçn **available l·∫°i** (hold expired) ‚úì

- [ ] **Test 4:** User thanh to√°n (webhook SePay)
  - [ ] Booking status = `confirmed`
  - [ ] Payment status = `paid`
  - [ ] Slot status = `booked` (lock vƒ©nh vi·ªÖn)
  - [ ] Check-in code ƒë∆∞·ª£c t·∫°o

- [ ] **Test 5:** Click "Xem Chi Ti·∫øt Booking" t·ª´ payment page
  - [ ] Navigate ƒë·∫øn `/bookings/123`
  - [ ] Hi·ªÉn th·ªã booking details (kh√¥ng 404)

- [ ] **Test 6:** Click "Xem M√£ Check-In"
  - [ ] Navigate ƒë·∫øn `/bookings/123/checkin-code`
  - [ ] Hi·ªÉn th·ªã m√£ check-in (kh√¥ng 404)

---

## üìù Frontend Implementation Notes

**Trong step 2 (Nh·∫≠p th√¥ng tin ng∆∞·ªùi ƒë·∫∑t):**
```javascript
// Ensure form fields are submitted with booking confirm
const confirmBooking = async () => {
  const payload = {
    slots: selectedSlots,
    customer: {
      name: formData.customerName,      // ‚Üê G·ª≠i
      email: formData.customerEmail,    // ‚Üê G·ª≠i
      phone: formData.customerPhone     // ‚Üê G·ª≠i
    },
    payment_method: "bank_transfer",
    total_price: totalPrice
  };
  
  // POST /fields/:fieldCode/bookings/confirm
  const response = await api.post(
    `/fields/${fieldCode}/bookings/confirm`,
    payload
  );
  
  // Redirect to payment page
  navigate(`/payment/${response.booking_code}`);
};
```

**Display availability correctly:**
```javascript
// getAvailability API tr·∫£ v·ªÅ slots v·ªõi:
// - status: "available" | "hold" | "booked"
// - hold_expires_at: "2025-10-20 18:05:00" | null
// - is_available: boolean (AI smart calculate)

const isSlotBookable = (slot) => {
  // Backend ƒë√£ t√≠nh to√°n smart, ch·ªâ c·∫ßn check is_available
  return slot.is_available === true;
};
```

---

## üöÄ Deployment Steps

1. **Backup database**
   ```sql
   -- Check columns exist
   SHOW COLUMNS FROM Field_Slots LIKE 'HoldExpiresAt';
   SHOW COLUMNS FROM Bookings LIKE 'CustomerName';
   ```

2. **Add columns if not exists** (migration script)
   ```sql
   ALTER TABLE Field_Slots ADD COLUMN HoldExpiresAt DATETIME NULL;
   ALTER TABLE Bookings ADD COLUMN CustomerName VARCHAR(255) NULL;
   ALTER TABLE Bookings ADD COLUMN CustomerEmail VARCHAR(255) NULL;
   ALTER TABLE Bookings ADD COLUMN CustomerPhone VARCHAR(20) NULL;
   ```

3. **Redeploy backend**
   ```bash
   cd backend
   npm install
   npm run build
   pm2 restart app  # ho·∫∑c deployment method c·ªßa b·∫°n
   ```

4. **Test APIs with Postman/curl**
   ```bash
   curl -X POST http://localhost:5050/api/fields/48/bookings/confirm \
     -H "Content-Type: application/json" \
     -d '{
       "slots": [{"play_date": "2025-10-25", "start_time": "18:00", "end_time": "19:00"}],
       "customer": {"name": "Tester", "email": "test@example.com", "phone": "0912345678"},
       "payment_method": "bank_transfer",
       "total_price": 300000
     }'
   ```

---

## üìû Support

N·∫øu g·∫∑p l·ªói:
- Check `backend/src/services/booking.service.ts` - logic t·∫°o booking
- Check `backend/src/services/payment.service.ts` - logic lock slot khi payment
- Check `backend/src/services/field.service.ts` - logic check availability
- Check database Field_Slots table - HoldExpiresAt column
